<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Mapa de Calor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        #map { height: 500px; width: 100%; border: 1px solid #ccc; }
        .info { margin-bottom: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
    </style>
</head>
<body>
    <h1>Teste do Mapa de Calor - TV Doutor Ads</h1>
    
    <div class="info">
        <h3>Status do Sistema:</h3>
        <p><strong>Edge Function:</strong> <span id="function-status">Verificando...</span></p>
        <p><strong>Dados do Heatmap:</strong> <span id="data-status">Verificando...</span></p>
        <p><strong>Total de Pontos:</strong> <span id="points-count">-</span></p>
    </div>

    <div id="map"></div>

    <div class="info">
        <h3>Como Interpretar:</h3>
        <ul>
            <li><strong>Azul:</strong> Baixa popularidade (poucas propostas)</li>
            <li><strong>Verde:</strong> Popularidade média</li>
            <li><strong>Amarelo:</strong> Alta popularidade</li>
            <li><strong>Vermelho:</strong> Muito alta popularidade</li>
        </ul>
    </div>

    <script>
        // Configuração do mapa
        const map = L.map('map').setView([-23.5505, -46.6333], 10);
        
        // Adicionar camada base
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Função para testar a Edge Function
        async function testHeatmapFunction() {
            try {
                const functionStatus = document.getElementById('function-status');
                const dataStatus = document.getElementById('data-status');
                const pointsCount = document.getElementById('points-count');

                // Simular chamada para a Edge Function
                // Em um ambiente real, você precisaria de autenticação
                const response = await fetch('https://vaogzhwzucijiyvyglls.supabase.co/functions/v1/maps-heatmap', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // 'Authorization': 'Bearer YOUR_TOKEN_HERE'
                    },
                    body: JSON.stringify({
                        stats: true,
                        cities: true,
                        classes: true
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.heatmap && data.heatmap.length > 0) {
                        // Sucesso - dados encontrados
                        functionStatus.innerHTML = '<span style="color: green;">✅ Funcionando</span>';
                        dataStatus.innerHTML = '<span style="color: green;">✅ Dados carregados</span>';
                        pointsCount.textContent = data.heatmap.length;
                        
                        // Adicionar pontos ao mapa
                        const heatmapData = data.heatmap.map(point => [point[0], point[1], point[2]]);
                        L.heatLayer(heatmapData, {
                            radius: 25,
                            blur: 15,
                            maxZoom: 18,
                            max: 1.0,
                            gradient: {
                                0.0: 'blue',
                                0.3: 'cyan',
                                0.5: 'lime',
                                0.7: 'yellow',
                                1.0: 'red'
                            }
                        }).addTo(map);
                        
                    } else {
                        // Edge Function funciona mas não há dados
                        functionStatus.innerHTML = '<span style="color: green;">✅ Funcionando</span>';
                        dataStatus.innerHTML = '<span style="color: orange;">⚠️ Sem dados</span>';
                        pointsCount.textContent = '0';
                    }
                } else {
                    // Erro na Edge Function
                    functionStatus.innerHTML = '<span style="color: red;">❌ Erro</span>';
                    dataStatus.innerHTML = '<span style="color: red;">❌ Falha na requisição</span>';
                    pointsCount.textContent = '-';
                }
            } catch (error) {
                console.error('Erro ao testar heatmap:', error);
                document.getElementById('function-status').innerHTML = '<span style="color: red;">❌ Erro de conexão</span>';
                document.getElementById('data-status').innerHTML = '<span style="color: red;">❌ Erro de rede</span>';
            }
        }

        // Executar teste ao carregar a página
        testHeatmapFunction();

        // Adicionar alguns pontos de exemplo se não houver dados
        setTimeout(() => {
            const pointsCount = document.getElementById('points-count');
            if (pointsCount.textContent === '-') {
                // Adicionar pontos de exemplo para demonstração
                const exampleData = [
                    [-23.5505, -46.6333, 0.8], // São Paulo - Alta popularidade
                    [-23.5500, -46.6300, 0.6], // São Paulo - Média popularidade
                    [-23.5600, -46.6400, 0.4], // São Paulo - Baixa popularidade
                ];
                
                L.heatLayer(exampleData, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 18,
                    max: 1.0,
                    gradient: {
                        0.0: 'blue',
                        0.3: 'cyan',
                        0.5: 'lime',
                        0.7: 'yellow',
                        1.0: 'red'
                    }
                }).addTo(map);
                
                document.getElementById('data-status').innerHTML = '<span style="color: blue;">ℹ️ Dados de exemplo</span>';
                pointsCount.textContent = exampleData.length;
            }
        }, 3000);
    </script>
</body>
</html>
